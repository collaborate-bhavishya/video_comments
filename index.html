<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YouTube Comments + Firebase</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; background-color: #f4f4f9; color: #333; }
    h2 { text-align: center; color: #d32f2f; }
    #controls, #comment-form { display: flex; gap: 10px; margin-top: 20px; }
    input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px 15px; border: none; background-color: #d32f2f; color: white; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    button:hover { background-color: #c62828; }
    #player { margin-top: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #comments-container { margin-top: 20px; }
    .comment { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; background-color: #fff; transition: background-color 0.3s; }
    .comment:hover { background-color: #f9f9f9; }
    .timestamp { color: #0077cc; font-weight: bold; margin-right: 15px; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>

  <h2>YouTube Video Comment Tool</h2>

  <div id="controls">
    <input type="text" id="videoUrlInput" placeholder="Paste full YouTube URL...">
    <button id="loadBtn">Load Video</button>
  </div>

  <div id="player"></div>

  <div id="comment-form" style="margin-top: 20px;">
    <input type="text" id="commentInput" placeholder="Write your comment...">
    <button id="addBtn">Add Comment</button>
  </div>

  <div id="comments-container"></div>

  <script src="https://www.youtube.com/iframe_api"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // ⬇️ STEP 2: PASTE YOUR FIREBASE CONFIGURATION HERE ⬇️
    // You get this from your Firebase project settings.
    const firebaseConfig = {
      apiKey: "AIzaSyDAoFpxtFrfmlAtH-wwDEYLbIt7KU2FCuk",
    authDomain: "video-timestamp.firebaseapp.com",
    projectId: "video-timestamp",
    storageBucket: "video-timestamp.firebasestorage.app",
    messagingSenderId: "431153894437",
    appId: "1:431153894437:web:74b51d7528e53ce43e5bcc",
    measurementId: "G-N454C02S7L"
    };

    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global variables
    let player;
    let videoId = '';
    let unsubscribe; // To stop listening for comments when a new video is loaded

    // ✅ Extract video ID from any valid YouTube URL
    function extractVideoId(url) {
      const regex = /(?:v=|\/)([0-9A-Za-z_-]{11})(?:\?|&|$)/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    // This function is called by the YouTube API once it's ready
    window.onYouTubeIframeAPIReady = function () {
      document.getElementById('loadBtn').disabled = false;
      console.log("YouTube API is ready.");
    };

    // ✅ Load the video when user clicks the button
    document.getElementById('loadBtn').addEventListener('click', () => {
      const url = document.getElementById('videoUrlInput').value.trim();
      const id = extractVideoId(url);

      if (!id) {
        alert("Could not find a valid YouTube Video ID in the URL.");
        return;
      }
      
      videoId = id;

      // If a player exists, load the new video. Otherwise, create a new player.
      if (player) {
        player.loadVideoById(videoId);
      } else {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: videoId,
          events: {
            'onReady': onPlayerReady
          }
        });
      }
      
      // Start listening for comments for the new video
      listenForComments();
    });

    // The API will call this function when the video player is ready.
    function onPlayerReady(event) {
        console.log("Player is ready.");
    }
    
    // ✅ Add comment at current time
    document.getElementById('addBtn').addEventListener('click', async () => {
      const text = document.getElementById('commentInput').value.trim();
      if (!text || !player || typeof player.getCurrentTime !== 'function' || !videoId) {
        alert("Please load a video and write a comment first.");
        return;
      }

      const time = Math.floor(player.getCurrentTime());

      try {
        await addDoc(collection(db, 'comments'), {
          videoId,
          time,
          text,
          createdAt: new Date()
        });
        document.getElementById('commentInput').value = ''; // Clear input on success
      } catch (error) {
        console.error("Error adding document: ", error);
        alert("Could not save comment. See console for details.");
      }
    });

    // ✅ Listen for real-time comments from Firestore using onSnapshot
    function listenForComments() {
      // If we are already listening to a previous video's comments, stop it.
      if (unsubscribe) {
        unsubscribe();
      }
      
      const commentsCollection = collection(db, 'comments');
      // ⚙️ IMPORTANT: This query requires a Firestore Index. See instructions.
      const q = query(commentsCollection, where('videoId', '==', videoId), orderBy('time'));

      unsubscribe = onSnapshot(q, (snapshot) => {
        const comments = [];
        snapshot.forEach(doc => {
          comments.push(doc.data());
        });
        renderComments(comments);
      }, (error) => {
        console.error("Error fetching comments: ", error);
        // This is where you'll see the "missing index" error in the console.
      });
    }

    // ✅ Display comments on the page
    function renderComments(comments) {
      const container = document.getElementById('comments-container');
      container.innerHTML = '<h3>Comments</h3>'; // Clear previous comments

      if (comments.length === 0) {
        container.innerHTML += '<p>No comments for this video yet.</p>';
        return;
      }
      
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.onclick = () => player.seekTo(c.time, true);
        div.innerHTML = `<span class="timestamp">${formatTime(c.time)}</span> ${c.text}`;
        container.appendChild(div);
      });
    }

    // ✅ Helper function to format seconds to mm:ss
    function formatTime(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

  </script>
</body>
</html>